name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Nur bei PRs oder wenn jemand @claude kommentiert
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          else
            PR_NUMBER=${{ github.event.issue.number }}
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get the diff
          gh pr diff $PR_NUMBER > diff.txt
          echo "Diff size: $(wc -l < diff.txt) lines"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Review
        id: review
        run: |
          # Read diff
          DIFF=$(cat diff.txt | head -c 50000)

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"Review this PR diff. Be concise. Focus on:\\n1. Bugs or errors\\n2. Security issues\\n3. Performance problems\\n4. Code style issues\\n\\nIf the code looks good, say so briefly.\\n\\nDiff:\\n\`\`\`\\n${DIFF}\\n\`\`\`\"
              }]
            }")

          # Extract review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not get review"')

          # Save for next step
          echo "REVIEW<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        run: |
          gh pr comment ${{ steps.diff.outputs.pr_number }} --body "## Claude Review

          ${{ steps.review.outputs.REVIEW }}

          ---
          *Automated review by Claude*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
